# Dockerfile.dev
FROM rust:1.75-bookworm

# Dépendances système pour le traitement d'image
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    libfreetype6-dev \
    libfontconfig1-dev \
    && rm -rf /var/lib/apt/lists/*

# Installer cargo-watch pour le hot reload
RUN cargo install cargo-watch

# Dossier de travail
WORKDIR /app

# Copier les fichiers de dépendances d'abord (pour cache Docker)
COPY Cargo.toml Cargo.lock ./
COPY backend/Cargo.toml backend/

# Pré-build des dépendances (optimisation)
RUN mkdir backend/src && \
    echo "fn main() {}" > backend/src/main.rs && \
    cargo build --manifest-path backend/Cargo.toml && \
    rm -rf backend/src

# Copier tout le code source
COPY . .

# Exposer le port du backend
EXPOSE 3000

# Lancer avec hot reload
CMD ["cargo", "watch", "-w", "backend/src", "-x", "run --manifest-path backend/Cargo.toml"]
